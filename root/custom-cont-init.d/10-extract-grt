#!/usr/bin/with-contenv bash
set -euo pipefail

# If /data is empty, extract grt-data.tar.gz into it and set permissions
ARCHIVE="/grt/grt-data.tar.gz"
DATA_DIR="/data"

if [ ! -f "$ARCHIVE" ]; then
  echo "[cont-init.d] Archive $ARCHIVE not found, skipping extraction"
  exit 0
fi

mkdir -p "$DATA_DIR"

# Check if /data is empty (no files besides . and ..)
if [ -z "$(ls -A "$DATA_DIR")" ]; then
  echo "[cont-init.d] /data is empty — extracting $ARCHIVE"
  tar -xzf "$ARCHIVE" -C "$DATA_DIR"

  if [ -f "$DATA_DIR/GordonsReloadingTool" ]; then
    chmod +x "$DATA_DIR/GordonsReloadingTool"
  fi

  chmod -R 777 "$DATA_DIR"
else
  echo "[cont-init.d] /data not empty — skipping extraction"
fi
